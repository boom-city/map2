# Pull from Subrepos Workflow - Pseudo Code

## Workflow Triggers
- **Manual dispatch** with optional subrepo_filter parameter
- **Scheduled execution** (currently disabled - was every hour)

## Main Algorithm Flow

```
FUNCTION pull_subrepos_workflow():
    pull_results = execute_pull_process()

    IF pull_results.has_changes:
        create_pull_request_for_changes()

    IF pull_results.has_conflicts:
        create_conflict_resolution_issue()
```

## Pull Process Execution

```
FUNCTION execute_pull_process():
    checkout_repository(fetch_depth=0)
    setup_git_configuration()

    pull_script = create_pull_script()
    results = execute_pull_script()

    RETURN {
        has_changes: git_has_changes(),
        has_conflicts: results.conflicts_detected,
        change_log: results.pull_log
    }
```

## Pull Script Implementation

```
FUNCTION create_pull_script():
    config = load_subrepo_configuration()
    filter = input.subrepo_filter

    INITIALIZE tracking:
        changes_detected = false
        conflicts_detected = false

    FOR EACH subrepo IN config.subrepos:
        IF should_process_subrepo(subrepo, filter):
            pull_subrepo(subrepo)

    RETURN process_results
```

## Individual Subrepo Pull Logic

```
FUNCTION pull_subrepo(prefix, remote, branch):
    # Skip if filter doesn't match
    IF filter_set AND NOT prefix.contains(filter):
        RETURN skip

    temp_repo = create_temp_directory()

    TRY:
        clone_repository(remote, branch, temp_repo)
    CATCH clone_error:
        log_warning("Remote repository not accessible: " + remote)
        cleanup_temp_directory(temp_repo)
        RETURN skip

    change_detection = compare_remote_with_local(temp_repo, prefix)

    IF change_detection.has_differences:
        sync_remote_to_local(temp_repo, prefix)

    cleanup_temp_directory(temp_repo)
```

## Change Detection and Comparison

```
FUNCTION compare_remote_with_local(temp_repo, prefix):
    change_directory(temp_repo)
    remote_hash = get_git_commit_hash()

    change_directory(monorepo_workspace)
    create_directory_if_missing(prefix)

    # Use rsync to detect differences
    differences = rsync_dry_run_with_delete(
        source=temp_repo + "/",
        target=prefix + "/",
        exclude=[".git"],
        show_changes=true
    )

    RETURN {
        has_differences: (differences.length > 0),
        remote_hash: remote_hash
    }
```

## File Synchronization Process

```
FUNCTION sync_remote_to_local(temp_repo, prefix):
    changes_detected = true

    # Create unique branch name for sync
    branch_name = "sync-" + sanitize_path(prefix) + "-" + timestamp()

    # Sync files using rsync
    rsync_with_delete(
        source=temp_repo + "/",
        target=prefix + "/",
        exclude=[".git"]
    )

    IF git_has_changes():
        git_add(prefix)

        # Get commit information from remote
        remote_commit_info = get_remote_commit_details(temp_repo)

        commit_message = build_sync_commit_message(prefix, remote_commit_info)
        git_commit(commit_message + "\n[skip ci]")

        log_success("Successfully pulled changes for " + prefix)
```

## Commit Message Construction

```
FUNCTION build_sync_commit_message(prefix, remote_info):
    base_message = "sync: Update " + prefix + " from remote"

    full_message = base_message +
                  "\n\nRemote commit: " + remote_info.hash +
                  "\nRemote message: " + remote_info.message

    RETURN full_message
```

## Pull Request Creation

```
FUNCTION create_pull_request_for_changes():
    branch_name = "sync-subrepos-" + timestamp()

    git_checkout_new_branch(branch_name)
    git_push_branch(branch_name)

    pr_body = build_pull_request_body()

    github_create_pull_request(
        title="üîÑ Sync: Update from subrepos",
        body=pr_body,
        base="main",
        head=branch_name,
        labels=["sync", "automated"]
    )
```

```
FUNCTION build_pull_request_body():
    body = "This PR contains updates pulled from individual subrepo repositories."
    body += "\n\n## Changes"
    body += "\n- Automated sync from subrepo remotes"
    body += "\n- Generated on: " + current_timestamp()
    body += "\n- Triggered by: " + github.event_name
    body += "\n\n## Review"
    body += "\nPlease review the changes before merging. If there are conflicts, they will need to be resolved manually."
    body += "\n\n---"
    body += "\n*This PR was automatically generated by the subrepo sync workflow.*"

    RETURN body
```

## Direct Push Option

```
FUNCTION push_changes_directly_if_applicable():
    IF manual_dispatch AND subrepo_filter_specified:
        log("Pushing filtered changes directly to main...")
        git_push_to_main()
```

## Conflict Detection and Handling

```
FUNCTION check_for_conflicts():
    # This job runs only if pull process failed
    IF pull_process_failed:
        create_conflict_resolution_issue()
```

```
FUNCTION create_conflict_resolution_issue():
    issue_body = build_conflict_issue_body()

    github_create_issue(
        title="‚ö†Ô∏è Subrepo sync conflicts detected",
        body=issue_body,
        labels=["conflict", "needs-attention"]
    )
```

```
FUNCTION build_conflict_issue_body():
    body = "Conflicts were detected during the automated subrepo sync process."
    body += "\n\n## Details"
    body += "\n- **Time:** " + current_timestamp()
    body += "\n- **Workflow Run:** " + github.workflow_run_url
    body += "\n\n## Required Action"
    body += "\nManual intervention is required to resolve the conflicts. Please:"
    body += "\n1. Review the workflow logs"
    body += "\n2. Manually sync the affected repositories"
    body += "\n3. Resolve any conflicts"
    body += "\n4. Close this issue when resolved"
    body += "\n\n---"
    body += "\n*This issue was automatically created by the subrepo sync workflow.*"

    RETURN body
```

## Key Implementation Notes

- **Non-Destructive**: Creates pull requests instead of direct pushes to main
- **Filtering**: Supports processing specific subrepos via filter parameter
- **Change Detection**: Uses rsync for efficient file difference detection
- **Branch Creation**: Creates timestamped branches for each sync operation
- **Conflict Handling**: Creates GitHub issues when conflicts are detected
- **Remote Validation**: Gracefully handles inaccessible remote repositories
- **CI Coordination**: Uses `[skip ci]` to prevent workflow recursion

## State Management

- **Directory State**: Creates local directories if they don't exist
- **Remote State**: Validates remote repository accessibility before sync
- **Change State**: Only processes subrepos with actual differences
- **Branch State**: Creates unique branch names to avoid conflicts
- **Commit State**: Preserves remote commit information in sync commits

## Error Recovery Patterns

- **Remote Access**: Continues with other repos if one remote is inaccessible
- **Conflict Detection**: Automatically creates issues for manual resolution
- **Cleanup**: Always removes temporary directories regardless of success/failure
- **Logging**: Comprehensive logging for debugging sync issues

## Integration Points

- **Manual Override**: Allows direct push for filtered single-repo syncs
- **Scheduled Execution**: Designed for automated periodic syncing (currently disabled)
- **Conflict Resolution**: Integrates with separate conflict resolution workflow