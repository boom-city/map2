# Auto-Bootstrap New Resources Workflow - Pseudo Code

## Workflow Triggers
- **Push events** to main/master affecting `.github/subrepo-config.json` or `resources/**`
- **Scheduled execution** every 6 hours
- **Manual dispatch** with force_bootstrap option

## Main Algorithm Flow

```
FUNCTION auto_bootstrap_workflow():
    detection_results = detect_needs_bootstrap()

    IF detection_results.needs_bootstrap:
        execute_auto_bootstrap(detection_results)
        trigger_push_workflow()

    generate_summary(detection_results)
```

## Bootstrap Detection Logic

```
FUNCTION detect_needs_bootstrap():
    checkout_repository(fetch_depth=2)

    INITIALIZE flags:
        needs_bootstrap = false
        missing_repos = []
        new_configs = false

    # Check configuration changes
    IF git_diff_contains("HEAD~1..HEAD", ".github/subrepo-config.json"):
        new_configs = true
        needs_bootstrap = true

    # Check resource file changes
    IF git_diff_contains("HEAD~1..HEAD", "resources/"):
        needs_bootstrap = true

    # Check for missing directories or remote repositories
    FOR EACH subrepo IN configuration:
        IF NOT directory_exists(subrepo.prefix) OR is_empty(subrepo.prefix):
            missing_repos.add(subrepo.prefix)
            needs_bootstrap = true

        IF NOT remote_repository_exists(subrepo.remote):
            missing_repos.add(subrepo.prefix)
            needs_bootstrap = true

    # Force bootstrap if requested
    IF input.force_bootstrap == true:
        needs_bootstrap = true

    RETURN {
        needs_bootstrap: needs_bootstrap,
        missing_repos: missing_repos,
        new_configs: new_configs
    }
```

## Repository Creation Process

```
FUNCTION execute_auto_bootstrap(detection_results):
    setup_git_user("GitHub Actions [Auto-Bootstrap]")

    IF detection_results.new_configs:
        create_missing_remote_repositories()

    bootstrap_missing_repositories()
    commit_bootstrapped_changes()
```

```
FUNCTION create_missing_remote_repositories():
    FOR EACH subrepo IN configuration:
        repo_info = parse_repository_url(subrepo.remote)

        IF NOT github_repo_exists(repo_info.owner, repo_info.name):
            TRY:
                github_create_repository(
                    owner=repo_info.owner,
                    name=repo_info.name,
                    visibility="private",
                    description="Auto-created subrepo for " + subrepo.prefix
                )
            CATCH creation_error:
                log_warning("Failed to create: " + repo_info.full_name)
```

## Local Bootstrap Process

```
FUNCTION bootstrap_missing_repositories():
    SET parallel_limit = 10
    counters = {success: 0, error: 0}

    FOR EACH subrepo IN configuration:
        IF should_bootstrap(subrepo):
            PARALLEL_EXECUTE bootstrap_repo(subrepo) WITH limit=parallel_limit

    WAIT_FOR_ALL_PARALLEL_JOBS()
    log_summary(counters)
```

```
FUNCTION bootstrap_repo(prefix, remote, branch):
    # Skip if already exists and not forced
    IF directory_exists(prefix) AND has_content(prefix) AND NOT force_bootstrap:
        RETURN success

    create_directory(prefix)

    TRY:
        # Try cloning from remote
        temp_dir = create_temp_directory()
        clone_repository(remote, branch, temp_dir, depth=1)
        move_content(temp_dir, prefix)
        remove_git_directory(prefix)
        success_count++
    CATCH clone_error:
        # Create empty structure if clone fails
        create_directory(prefix)
        write_file(prefix + "/README.md", "# " + prefix)
        log_warning("Created empty structure for " + prefix)
        success_count++
```

## Change Management

```
FUNCTION commit_bootstrapped_changes():
    IF git_has_changes():
        git_add_all()

        commit_message = build_commit_message()
        git_commit(commit_message)
        git_push_to_main()
    ELSE:
        log("No changes to commit")
```

```
FUNCTION build_commit_message():
    base_message = "chore: auto-bootstrap new resources"

    IF new_configs_detected:
        base_message += "\n\n- Configuration changes detected"

    IF missing_repos_found:
        base_message += "\n- Missing repositories initialized"

    base_message += "\n\nðŸ¤– Auto-generated by bootstrap automation"
    base_message += "\n[skip ci]"

    RETURN base_message
```

## Integration with Push Workflow

```
FUNCTION trigger_push_workflow():
    IF bootstrap_successful:
        github_workflow_dispatch(
            workflow="push-subrepos.yml",
            inputs={commit_range: "HEAD~1..HEAD"}
        )
```

## Summary Generation

```
FUNCTION generate_summary(detection_results, bootstrap_results):
    summary = {
        triggered_by: workflow_event_name,
        actor: github_actor,
        timestamp: current_time,
        bootstrap_needed: detection_results.needs_bootstrap,
        new_configs: detection_results.new_configs,
        missing_repos: detection_results.missing_repos,
        bootstrap_status: bootstrap_results.status
    }

    create_github_step_summary(summary)
```

## Key Implementation Notes

- **Smart Detection**: Only bootstraps when actual changes or missing repositories detected
- **Remote Creation**: Automatically creates GitHub repositories for new configurations
- **Graceful Degradation**: Creates empty directory structure if remote clone fails
- **Parallel Processing**: Limits concurrent operations to prevent rate limiting
- **Integration**: Triggers push workflow to sync newly created repositories
- **CI Coordination**: Uses `[skip ci]` to prevent infinite workflow loops

## State Management

- **Directory State**: Checks for both existence and content
- **Remote State**: Validates GitHub repository accessibility
- **Configuration State**: Compares current vs. previous config versions
- **Force Override**: Manual force option bypasses all state checks